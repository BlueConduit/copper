name: Release packages

on:
  push:
    branches:
      - main

env:
  CI: true
  PNPM_CACHE_FOLDER: .pnpm-store

jobs:
  version-and-release:
    runs-on: macos-latest

    steps:
    - name: Checkout code repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    
    - name: Setup Node 16
      uses: actions/setup-node@v2
      with:
        node-version: 16
    
    - name: Install pnpm
      run: npm i pnpm@latest -g

    - name: Setup .npmrc file
      run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

    - name: Setup pnpm config
      run: pnpm config set store-dir $PNPM_CACHE_FOLDER

    - name: Install dependencies
      ## We're in CI env so --frozen-lockfile is used by default here, fails if there is
      ## no lockfile present. Neat!
      run: pnpm install

    - name: Create and publish versions
      uses: changesets/action@v1
      with:
        commit: "chore: update versions"
        title: "chore: update versions"
        publish: pnpm ci:publish
